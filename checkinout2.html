<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-in</title>
  <!-- Thêm Google Identity Services (GIS) SDK -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Click to Check-in</h2>
  <button onclick="checkGeolocationPermission()">Check-in</button>
  
  <!-- Nút đăng nhập Google sẽ được render tại đây -->
  <div id="google-signin" style="display:none;"></div>
  
  <p id="location"></p>
  <p id="result"></p>

  <script>
    // Kiểm tra quyền truy cập vị trí trước khi yêu cầu
    function checkGeolocationPermission() {
      if (navigator.permissions) {
        navigator.permissions.query({ name: 'geolocation' }).then(function(permissionStatus) {
          if (permissionStatus.state === 'granted') {
            // Quản lý quyền đã được cấp
            getLocation();
          } else if (permissionStatus.state === 'prompt') {
            // Yêu cầu quyền
            getLocation();
          } else {
            // Quyền bị từ chối
            alert('Permission to access geolocation is denied. Please enable it in your browser settings.');
          }
        });
      } else {
        // Trình duyệt không hỗ trợ Permissions API, mặc định yêu cầu quyền
        getLocation();
      }
    }

    // Hàm giải mã token JWT để lấy thông tin người dùng
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }

    // Hàm xử lý đăng nhập Google
    function onSignIn(googleUser) {
      // Lấy credential (JWT token) từ googleUser
      const credential = googleUser.credential;

      // Giải mã token JWT và lấy thông tin người dùng
      const userInfo = parseJwt(credential);

      // Thông tin người dùng
      const email = userInfo.email;
      console.log("Logged in as: " + email);

      document.getElementById("google-signin").style.display = "none"; // Ẩn nút đăng nhập sau khi thành công

      // Sau khi đăng nhập, tiến hành check-in và gửi thông tin thêm (email, tọa độ,...)
      getLocation(email);
    }

    // Hàm tính khoảng cách giữa 2 điểm tọa độ
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of the earth in km
      const dLat = (lat2 - lat1) * (Math.PI / 180);
      const dLon = (lon2 - lon1) * (Math.PI / 180);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const distance = R * c * 1000; // Khoảng cách tính bằng mét
      return distance;
    }

    // Danh sách các phạm vi check-in
    const checkinAreas = [
      { id: 1, name: "Văn Phòng Kengnam 1", lat: 21.01761819163046, lon: 105.78359509798412, radius: 100 },
      { id: 2, name: "Văn Phòng Kengnam 2", lat: 21.017765, lon: 105.783593, radius: 100 },
      { id: 3, name: "Văn Phòng Kengnam 3", lat: 21.018501, lon: 105.785030, radius: 100 },
      { id: 4, name: "Văn Phòng Kengnam 4", lat: 21.016610, lon: 105.784220, radius: 100 },
      { id: 5, name: "Văn Phòng Kengnam 5", lat: 21.017037, lon: 105.783599, radius: 100 },
      { id: 6, name: "Văn Phòng Kengnam 6", lat: 21.017037, lon: 105.783599, radius: 100 },
    ];

    // Lấy vị trí người dùng
    function getLocation(email) {
      if (navigator.geolocation) {
        // Sử dụng tùy chọn để cải thiện độ chính xác của vị trí
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLat = position.coords.latitude;
          var userLon = position.coords.longitude;

          document.getElementById("location").innerHTML = `Latitude: ${userLat}<br>Longitude: ${userLon}`;

          // Kiểm tra người dùng có nằm trong phạm vi check-in nào không
          checkUserLocation(userLat, userLon, email);
        }, function(error) {
          document.getElementById("location").innerHTML = "Location error: " + error.message;
        }, {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        });
      } else {
        document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    // Kiểm tra người dùng có nằm trong phạm vi check-in không
    function checkUserLocation(userLat, userLon, email) {
      let isInArea = false;

      for (let i = 0; i < checkinAreas.length; i++) {
        const area = checkinAreas[i];
        const distance = calculateDistance(userLat, userLon, area.lat, area.lon);

        document.getElementById("result").innerHTML += `Distance to ${area.name}: ${distance.toFixed(2)}m<br>`;

        if (distance <= area.radius) {
          document.getElementById("result").innerHTML += `You are within the check-in area: ${area.name}. Distance: ${distance.toFixed(2)}m<br>`;
          sendLocationToBackend(userLat, userLon, "checkin", area.id, email);
          isInArea = true;
          break;
        }
      }

      if (!isInArea) {
        document.getElementById("result").innerHTML += `You are outside the check-in area.<br>`;
        sendLocationToBackend(userLat, userLon, "checkout", null, email);
      }
    }

    // Gửi dữ liệu tọa độ và email đến backend
    function sendLocationToBackend(lat, lon, action, areaId, email) {
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "your-backend-api-url", true);
      xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

      const data = {
        latitude: lat,
        longitude: lon,
        action: action,
        areaId: areaId,
        email: email // Thêm email vào dữ liệu gửi đi
      };
	console.log(data);
      xhr.onload = function() {
        if (xhr.status === 200) {
          console.log("Location and email data successfully sent:", xhr.responseText);
        } else {
          console.error("Failed to send data:", xhr.status, xhr.statusText);
        }
      };

      xhr.onerror = function() {
        console.error("Network error occurred while sending location data.");
      };

      xhr.send(JSON.stringify(data));
    }

    // Kiểm tra trạng thái đăng nhập Google
    function checkGoogleLogin() {
      google.accounts.id.initialize({
        client_id: "1049791283951-hffa25ar70ml4tevipp78g6mmqntjocr.apps.googleusercontent.com", // Thay "YOUR_GOOGLE_CLIENT_ID" bằng ID ứng dụng của bạn
        callback: onSignIn
      });

      google.accounts.id.prompt(); // Hiển thị prompt nếu người dùng chưa đăng nhập

      google.accounts.id.renderButton(
        document.getElementById("google-signin"),
        { theme: "outline", size: "large" }
      );

      document.getElementById("google-signin").style.display = "block"; // Hiển thị nút đăng nhập Google
    }

    // Kiểm tra trạng thái ngay khi trang tải
    window.onload = function() {
      checkGoogleLogin();
    }
  </script>
</body>
</html>





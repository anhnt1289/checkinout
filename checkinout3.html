<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-in & Check-out</title>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check-in & Check-out</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f7fc;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }

    /* Cải thiện tiêu đề */
    h2 {
      font-size: 3rem; /* Tăng kích thước font chữ */
      font-weight: bold;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 1px; /* Thêm khoảng cách giữa các chữ cái */
      text-align: center;
      margin-bottom: 30px;
      background: linear-gradient(90deg, #4CAF50, #FF5733); /* Thêm gradient màu */
      -webkit-background-clip: text;
      color: transparent;
      animation: gradientAnimation 3s infinite alternate;
    }

    @keyframes gradientAnimation {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    .container {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
      width: 400px;
      text-align: center;
    }

    .buttons-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    button {
      padding: 18px 40px;
      border: none;
      border-radius: 10px;
      font-size: 1.5rem;
      cursor: pointer;
      font-weight: bold;
      text-transform: uppercase;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 10px rgba(0, 0, 0, 0.2);
    }

    button.checkin {
      background-color: #4CAF50;
      color: #fff;
    }

    button.checkin:hover {
      background-color: #45a049;
    }

    button.checkout {
      background-color: #FF5733;
      color: #fff;
    }

    button.checkout:hover {
      background-color: #e04e2c;
    }

    .google-signin {
      margin-top: 20px;
    }

    #location, #result {
      margin-top: 10px;
      font-size: 1rem;
      color: #555;
    }

    .status {
      font-weight: bold;
      color: #333;
    }

    #google-signin {
      margin-top: 20px;
    }

    #google-signin .g-signin2 {
      display: inline-block;
    }

    /* Media Query: Thiết kế responsive */
    @media (max-width: 768px) {
      h2 {
        font-size: 2rem; /* Giảm kích thước tiêu đề trên thiết bị di động */
      }

      .container {
        width: 90%; /* Chiếm 90% chiều rộng của màn hình trên di động */
        padding: 20px;
      }

      button {
        font-size: 1.2rem; /* Giảm kích thước font chữ của button trên di động */
        padding: 16px 30px;
      }
    }

    @media (max-width: 480px) {
      h2 {
        font-size: 1.5rem; /* Thay đổi kích thước cho các thiết bị rất nhỏ */
      }

      button {
        font-size: 1rem; /* Giảm kích thước button trên các thiết bị di động nhỏ */
        padding: 12px 25px;
      }

      .container {
        width: 95%; /* Cho container rộng hơn để phù hợp với màn hình nhỏ */
        padding: 15px;
      }

      #location, #result {
        font-size: 0.9rem; /* Giảm kích thước font chữ của thông báo trên di động */
      }
    }
  </style>
  <!-- Thêm Google Identity Services (GIS) SDK -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Click to Check-in or Check-out</h2>

  <div class="container">
    <div class="buttons-container">
      <button class="checkin" onclick="checkGeolocationPermission('checkin')">Check-in</button>
      <button class="checkout" onclick="checkGeolocationPermission('checkout')">Check-out</button>
    </div>

    <div id="google-signin" style="display:none;"></div>

    <p id="location"></p>
    <p id="result" class="status"></p>
  </div>

  <script>
	function checkGeolocationPermission(action) {
	  if (navigator.permissions) {
	    navigator.permissions.query({ name: 'geolocation' }).then(function(permissionStatus) {
	      if (permissionStatus.state === 'granted') {
	        // Kiểm tra xem người dùng đã đăng nhập và email còn hợp lệ
	        const loginData = JSON.parse(localStorage.getItem('loginData'));
	
	        if (loginData && isLoginValid(loginData.timestamp)) {
	          getLocation(loginData.email, action);
	        } else {
	          alert('Session expired. Please login again.');
	        }
	      } else if (permissionStatus.state === 'prompt') {
	        // Nếu chưa có quyền, yêu cầu quyền và sau đó gọi getLocation
	        const loginData = JSON.parse(localStorage.getItem('loginData'));
	
	        if (loginData && isLoginValid(loginData.timestamp)) {
	          getLocation(loginData.email, action);
	        } else {
	          alert('Session expired. Please login again.');
	        }
	      } else {
	        alert('Permission to access geolocation is denied. Please enable it in your browser settings.');
	      }
	    });
	  } else {
	    // Nếu trình duyệt không hỗ trợ Permissions API, kiểm tra trạng thái đăng nhập và gọi getLocation
	    const loginData = JSON.parse(localStorage.getItem('loginData'));
	
	    if (loginData && isLoginValid(loginData.timestamp)) {
	      getLocation(loginData.email, action);
	    } else {
	      alert('Session expired. Please login again.');
	    }
	  }
	}
	
	// Kiểm tra xem phiên đăng nhập còn hợp lệ (dưới 30 phút)
	function isLoginValid(timestamp) {
	  const thirtyMinutesInMillis = 30 * 60 * 1000; // 30 phút tính bằng mili giây
	  return (Date.now() - timestamp) <= thirtyMinutesInMillis;
	}

    // Hàm giải mã token JWT để lấy thông tin người dùng
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }

    // Hàm xử lý đăng nhập Google
    function onSignIn(googleUser) {
      // Lấy credential (JWT token) từ googleUser
      const credential = googleUser.credential;

      // Giải mã token JWT và lấy thông tin người dùng
      const userInfo = parseJwt(credential);
	  // Lưu email và thời gian (timestamp) vào localStorage
	  const loginData = {
		email: userInfo.email,
		timestamp: Date.now()  // Thời gian hiện tại tính bằng mili giây
	  };
	
	  localStorage.setItem('loginData', JSON.stringify(loginData));
      // Thông tin người dùng
      const email = userInfo.email;
      console.log("Logged in as: " + email);

      document.getElementById("google-signin").style.display = "none"; // Ẩn nút đăng nhập sau khi thành công
    }

    // Lấy vị trí người dùng
    function getLocation(email, action) {
      if (navigator.geolocation) {
        // Sử dụng tùy chọn để cải thiện độ chính xác của vị trí
        navigator.geolocation.getCurrentPosition(function(position) {
          var userLat = position.coords.latitude;
          var userLon = position.coords.longitude;

          document.getElementById("location").innerHTML = `Latitude: ${userLat}<br>Longitude: ${userLon}`;

          // Kiểm tra người dùng có nằm trong phạm vi check-in nào không
		  sendLocationToBackend(userLat, userLon, action, email);
        }, function(error) {
          document.getElementById("location").innerHTML = "Location error: " + error.message;
        }, {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        });
      } else {
        document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
      }
    }

    // Gửi dữ liệu tọa độ và email đến backend
  // Gửi dữ liệu tọa độ và email đến backend
  function sendLocationToBackend(lat, lon, action, email) {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", "https://checkinout-production.up.railway.app/api/location/send", true);
    xhr.setRequestHeader("Content-Type", "application/json");

    // Tạo JSON object khớp với LocationRequestDto
    const payload = {
      lat: lat,
      lon: lon,
      action: action,
      user: email
    };

    console.log("Sending JSON payload:", payload);

    // Xử lý khi API trả về
	xhr.onload = function () {
	  if (xhr.status === 200) {
	    console.log("Location and email data successfully sent:", xhr.responseText);
	
	    try {
	      const response = JSON.parse(xhr.responseText);
	
	      // Tạo tiêu đề dựa trên status
	      const title = response.status === "success" ? "✅ SUCCESS" : "❌ FAIL";
	
	      // Hiển thị alert với 2 dòng
	      alert(`${title}\n${response.message}`);
	
	    } catch (e) {
	      console.error("Failed to parse response:", e);
	      alert("❌ FAIL\nInvalid response from server");
	    }
	
	  } else {
	    console.error("Failed to send data:", xhr.status, xhr.statusText, xhr.responseText);
	    alert(`❌ FAIL\nFailed to send data: ${xhr.status} ${xhr.statusText}`);
	  }
	};

    // Xử lý lỗi kết nối
    xhr.onerror = function () {
      console.error("Network error occurred while sending location data.");
    };

    // Gửi dữ liệu dưới dạng JSON
    xhr.send(JSON.stringify(payload));
  }


    // Kiểm tra trạng thái đăng nhập Google
    function checkGoogleLogin() {
      google.accounts.id.initialize({
        client_id: "1049791283951-hffa25ar70ml4tevipp78g6mmqntjocr.apps.googleusercontent.com", // Thay "YOUR_GOOGLE_CLIENT_ID" bằng ID ứng dụng của bạn
        callback: onSignIn
      });

      google.accounts.id.prompt(); // Hiển thị prompt nếu người dùng chưa đăng nhập

      google.accounts.id.renderButton(
        document.getElementById("google-signin"),
        { theme: "outline", size: "large" }
      );

      document.getElementById("google-signin").style.display = "block"; // Hiển thị nút đăng nhập Google
    }

    // Kiểm tra trạng thái ngay khi trang tải
    window.onload = function() {
      checkGoogleLogin();
    }
  </script>
</body>
</html>









